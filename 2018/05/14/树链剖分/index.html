<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="high-cold">
  <!-- Open Graph Data -->
  <meta property="og:title" content="树链剖分"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="High-Cold"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.com"/>
  
    <link rel="alternate" href="/atom.xml" title="High-Cold" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>High-Cold</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>


<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

<style>
    .pace .pace-progress {
    	background: #1E92FB; /*进度条颜色*/
    	height: 3px;
    }
    .pace .pace-progress-inner {
     	box-shadow: 0 0 10px #1E92FB, 0 0 5px #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
    	border-top-color: #1E92FB;	/*上边框颜色*/
    	border-left-color: #1E92FB;	/*左边框颜色*/
    }
  </style>
  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-light.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">树链剖分</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By high-cold</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">05/14/18</span>
            <span class="time">19:21:12</span>
          </span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/蒟蒻的板子/">#蒟蒻的板子</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>#include <algorithm> //STL通用算法</algorithm></p>
<p>#include <cmath> //定义数学函数</cmath></p>
<p>#include <cstdio> //定义输入/输出函数</cstdio></p>
<p>#include <iostream> //数据流输入/输出</iostream></p>
<p>#include <cstring> //字符串处理</cstring></p>
<p>#include <string> //字符串类</string></p>
<p>#include <ctime> //定义关于时间的函数</ctime></p>
<p>#define itn int</p>
<p>#define fro for</p>
<p>#define ll long long</p>
<p>#define reg register</p>
<p>#define inf 1234567890</p>
<p>#define lson rt&lt;&lt;1,l,mid</p>
<p>#define rson rt&lt;&lt;1|1,mid+1,r</p>
<p>#define mid ((l+r)&gt;&gt;1)</p>
<p>#define len (r-l+1)<br>/*#include <bitset> //STL位集容器</bitset></p>
<p>#include <cstype> //字符处理</cstype></p>
<p>#include <cerrno> //定义错误码</cerrno></p>
<p>#include <complex> //复数类</complex></p>
<p>#include <clocale> //定义本地化函数</clocale></p>
<p>#include <cstdlib> //定义杂项函数及内存分配函数</cstdlib></p>
<p>#include <deque> //STL双端队列容器</deque></p>
<p>#include <exception> //异常处理类</exception></p>
<p>#include <fstream> //文件输入/输出</fstream></p>
<p>#include <functional> //STL定义运算函数(代替运算符)</functional></p>
<p>#include <limits> //定义各种数据类型最值常量</limits></p>
<p>#include <list> //STL线性列表容器</list></p>
<p>#include <map> //STL映射容器</map></p>
<p>#include <iomanip> //参数化输入/输出</iomanip></p>
<p>#include <ios> //基本输入/输出支持</ios></p>
<p>#include <iosfwd> //输入/输出系统使用的前置声明</iosfwd></p>
<p>#include <istream> //基本输入流</istream></p>
<p>#include <ostream> //基本输出流</ostream></p>
<p>#include <queue> //STL队列容器</queue></p>
<p>#include <set> //STL集合容器</set></p>
<p>#include <sstream> //基于字符串的流</sstream></p>
<p>#include <stack> //STL堆栈容器</stack></p>
<p>#include <stdexcept> //标准异常类</stdexcept></p>
<p>#include <streambuf> //底层输入/输出支持</streambuf></p>
<p>#include <utility> //STL通用模板类</utility></p>
<p>#include <vector> //STL动态数组容器</vector></p>
<p>#include &lt;cwchar.h&gt;//宽字符处理及输入/输出</p>
<p>#include &lt;cwctype.h&gt; //宽字符分类*/</p>
<p>using namespace std;</p>
<p>int max(int x,int y){return x&gt;y?x:y;}</p>
<p>int min(int x,int y){return x&lt;y?x:y;}</p>
<p>int read()<br>{<br>    int x=0,f=1;char ch=getchar();<br>    while (ch&lt;’0’ || ch&gt;’9’){if (ch==’-‘)f=-1;ch=getchar();}<br>    while (‘0’&lt;=ch &amp;&amp; ch&lt;=’9’){x=x<em>10+(ch^48);ch=getchar();}<br>    return x</em>f;<br>}</p>
<p>void write(int x)<br>{<br>    int buf[50];<br>    if (x&lt;0) putchar(‘-‘),x=-x;<br>    buf[0]=0;<br>    while (x) buf[++buf[0]]=x%10,x/=10;<br>    if (!buf[0]) buf[0]=1,buf[1]=0;<br>    while (buf[0]) putchar(‘0’+buf[buf[0]–]);<br>}</p>
<p>int to[200200],nex[200200],id[200200],beg[200200],laz[200200],a[200200],w[200200],deep[200200],son[200200],fa[200200],top[200200],siz[200200],wt[200200];<br>int cnt,e=0,mod,m,res,n,r;</p>
<p>void add(int x,int y)<br>{<br>    to[++e]=y;<br>    nex[e]=beg[x];<br>    beg[x]=e;<br>}</p>
<p>void pushdown(int rt,int lenn)<br>{<br>    laz[rt&lt;&lt;1]+=laz[rt];<br>    laz[rt&lt;&lt;1|1]+=laz[rt];<br>    a[rt&lt;&lt;1]+=laz[rt]<em>(lenn-(lenn&gt;&gt;1));<br>    a[rt&lt;&lt;1|1]+=laz[rt]</em>(lenn&gt;&gt;1);<br>    a[rt&lt;&lt;1]%=mod;<br>    a[rt&lt;&lt;1|1]%=mod;<br>    laz[rt]=0;<br>}</p>
<p>void build(int rt,int l,int r)<br>{<br>    if (l==r)<br>    {<br>        a[rt]=w[l];<br>        if (a[rt]&gt;mod) a[rt]%=mod;<br>        return ;<br>    }<br>    build(lson);<br>    build(rson);<br>    a[rt]=(a[rt&lt;&lt;1]+a[rt&lt;&lt;1|1])%mod;<br>}</p>
<p>void query(int rt,int l,int r,int L,int R)<br>{<br>    if (L&lt;=l&amp;&amp;r&lt;=R)<br>    {<br>        res+=a[rt];<br>        res%=mod;<br>        return;<br>    }<br>    else<br>    {<br>        if (laz[rt]) pushdown(rt,len);<br>        if (L&lt;=mid) query(lson,L,R);<br>        if (R&gt;mid) query(rson,L,R);<br>    }<br>}</p>
<p>void update(int rt,int l,int r,int L,int R,int k)<br>{<br>    if (L&lt;=l&amp;&amp;r&lt;=R)<br>    {<br>        laz[rt]+=k;<br>        a[rt]+=k*len;<br>    }<br>    else<br>    {<br>        if (laz[rt]) pushdown(rt,len);<br>        if (L&lt;=mid) update(lson,L,R,k);<br>        if (R&gt;mid) update(rson,L,R,k);<br>        a[rt]=(a[rt&lt;&lt;1]+a[rt&lt;&lt;1|1])%mod;<br>    }<br>}</p>
<p>int qRange(int x,int y)<br>{<br>    int ans=0;<br>    while (top[x]!=top[y])<br>    {<br>        if (deep[top[x]]&lt;deep[top[y]]) swap(x,y);<br>        res=0;<br>        query(1,1,n,id[top[x]],id[x]);<br>        ans+=res;<br>        ans%=mod;<br>        x=fa[top[x]];<br>    }<br>    if (deep[x]&gt;deep[y]) swap(x,y);<br>    res=0;<br>    query(1,1,n,id[x],id[y]);<br>    ans+=res;<br>    return ans%mod;<br>}</p>
<p>void updRange(int x,int y,int k)<br>{<br>    k%=mod;<br>    while (top[x]!=top[y])<br>    {<br>        if (deep[top[x]]&lt;deep[top[y]]) swap(x,y);<br>        update(1,1,n,id[top[x]],id[x],k);<br>        x=fa[top[x]];<br>    }<br>    if (deep[x]&gt;deep[y]) swap(x,y);<br>    update(1,1,n,id[x],id[y],k);<br>}</p>
<p>int qSon(int x)<br>{<br>    res=0;<br>    query(1,1,n,id[x],id[x]+siz[x]-1);<br>    return res;<br>}</p>
<p>void updSon(int x,int k){update(1,1,n,id[x],id[x]+siz[x]-1,k);}</p>
<p>void dfs1(int x,int f)<br>{<br>    deep[x]=deep[f]+1;<br>    fa[x]=f;<br>    siz[x]=1;<br>    int maxson=-1;<br>    for (int i=beg[x];i;i=nex[i])<br>    {<br>        if (to[i]==f) continue;<br>        dfs1(to[i],x);<br>        siz[x]+=siz[to[i]];<br>        if (siz[to[i]]&gt;maxson) son[x]=to[i],maxson=siz[to[i]];<br>    }<br>}</p>
<p>void dfs2(int x,int topf)<br>{<br>    id[x]=++cnt;<br>    wt[cnt]=w[x];<br>    top[x]=topf;<br>    if (!son[x]) return;<br>    dfs2(son[x],topf);<br>    for (int i=beg[x];i;i=nex[i])<br>        if (to[i]!=fa[x]&amp;&amp;to[i]!=son[x]) dfs2(to[i],to[i]);<br>}</p>
<p>int main(){<br>    n=read(),m=read(),r=read(),mod=read();<br>    for (int i=1;i&lt;=n;i++) w[i]=read();<br>    for (int i=1;i&lt;n;i++)<br>    {<br>        int a=read(),b=read();<br>        add(a,b);add(b,a);<br>    }<br>    deep[0]=0;<br>    dfs1(r,0);<br>    dfs2(r,r);<br>    build(1,1,n);<br>    while (m–)<br>    {<br>        int k=read();<br>        if (k==1)<br>        {<br>            int x=read(),y=read(),z=read();<br>            updRange(x,y,z);<br>        }<br>        else<br>        if (k==2)<br>        {<br>            int x=read(),y=read();<br>            printf(“%d\n”,qRange(x,y));<br>        }<br>        else<br>        if (k==3)<br>        {<br>            int x=read(),y=read();<br>            updSon(x,y);<br>        }<br>        else<br>        {<br>            int x=read();<br>            printf(“%d\n”,qSon(x));<br>        }<br>    }<br>    return 0;<br>}</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

